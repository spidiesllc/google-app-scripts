const SHEET_NAME = '8k Real'; // <-- changeable
const SHEET_ID = '1yEfPuPGhCM5QvR4RQ7w-TuiDfpvAvMQkJX5DYkZ1Lr8'; // <-- changeable
const BITLY_TOKEN = 'dada6b9359f515d776f8413fdcaec1d4a69153dc';  // <-- changeable
const START_ROW = 3; // <-- NEW: start row (1-based, row 3 means it skips headers) // <-- changeable

function updateBitlyClicks() {
  const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();

  const headers = data[0].map(h => h.toString().toLowerCase());
  const bitlyIndex = headers.indexOf('bitly link');
  const clicksIndex = headers.indexOf('clicks');

  if (bitlyIndex === -1 || clicksIndex === -1) {
    throw new Error("Bitly Link or Clicks column not found (check headers).");
  }

  for (let i = START_ROW - 1; i < data.length; i++) {
    const url = data[i][bitlyIndex];
    if (url && typeof url === 'string' && url.startsWith('http')) {
      const linkId = extractBitlyId(url);
      if (linkId) {
        const clicks = getClickCount(linkId);
        sheet.getRange(i + 1, clicksIndex + 1).setValue(clicks);
        Utilities.sleep(500); // Rate limiting
      }
    }
  }
}

// Helper to extract bitlink ID
function extractBitlyId(url) {
  return url.replace(/^https?:\/\/bit\.ly\//, '');
}

// Fetch click count from Bitly
function getClickCount(bitlinkId) {
  const endpoint = `https://api-ssl.bitly.com/v4/bitlinks/bit.ly/${bitlinkId}/clicks/summary`;

  const options = {
    method: 'get',
    contentType: 'application/json',
    headers: {
      Authorization: `Bearer ${BITLY_TOKEN}`
    },
    muteHttpExceptions: true
  };

  const response = UrlFetchApp.fetch(endpoint, options);
  const code = response.getResponseCode();

  if (code === 200) {
    const json = JSON.parse(response.getContentText());
    return json.total_clicks || 0;
  } else {
    console.warn(`Error ${code} for ${bitlinkId}`);
    return 0;
  }
}
